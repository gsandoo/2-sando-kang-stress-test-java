name: Java CI

on:
  push:
    branches: ["main"]

jobs:
  build-docker-image:
    runs-on: ubuntu-latest
    steps:
      # âœ… Git ì²´í¬ì•„ì›ƒ
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          submodules: true
          fetch-depth: 0

      # âœ… í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬ ë° íŒŒì¼ í™•ì¸ (Gradle íŒŒì¼ì´ ìˆëŠ”ì§€ ì²´í¬)
      - name: Check Current Directory and Files
        run: |
          echo "ğŸ“‚ í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬:"
          pwd
          echo "ğŸ“„ í˜„ì¬ ë””ë ‰í† ë¦¬ ë‚´ íŒŒì¼ ë¦¬ìŠ¤íŠ¸:"
          ls -la
          echo "ğŸ” Gradle ë¹Œë“œ ê´€ë ¨ íŒŒì¼ í™•ì¸:"
          ls -la | grep -E "build.gradle|settings.gradle"

      # âœ… JDK 17 ì„¤ì¹˜
      - name: Set Up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # âœ… Gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission to Gradlew
        run: chmod +x ./gradlew

      # âœ… Gradle ë¹Œë“œ ì‹¤í–‰ (ë¹Œë“œ ë¡œê·¸ ì¶œë ¥)
      - name: Build with Gradle Wrapper
        run: |
          echo "ğŸš€ Gradle ë¹Œë“œ ì‹œì‘"
          ./gradlew clean bootJar
        continue-on-error: false

      # âœ… Docker Hub ë¡œê·¸ì¸
      - name: Login To DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ
      - name: Image Build
        env:
          NAME: ${{ secrets.DOCKERHUB_USERNAME }}
          REPO: ${{ secrets.DOCKERHUB_REPOSITORY }}
        run: |
          echo "ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘"
          docker build -t $NAME/$REPO:latest .
          echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"

      # âœ… ë¹Œë“œëœ Docker ì´ë¯¸ì§€ í™•ì¸
      - name: Show Docker Images
        run: |
          echo "ğŸ“ í˜„ì¬ ë¡œì»¬ì— ìˆëŠ” Docker ì´ë¯¸ì§€:"
          docker images

      # âœ… Docker ì´ë¯¸ì§€ í‘¸ì‹œ ë° digest í™•ì¸
      - name: Push Docker Image
        env:
          NAME: ${{ secrets.DOCKERHUB_USERNAME }}
          REPO: ${{ secrets.DOCKERHUB_REPOSITORY }}
        run: |
          echo "ğŸš€ DockerHubë¡œ ì´ë¯¸ì§€ í‘¸ì‹œ ì‹œì‘"
          docker push $NAME/$REPO:latest
          echo "âœ… Docker ì´ë¯¸ì§€ í‘¸ì‹œ ì™„ë£Œ"

          echo "ğŸ” í‘¸ì‹œëœ Docker ì´ë¯¸ì§€ digest í™•ì¸"
          docker inspect --format='{{index .RepoDigests 0}}' $NAME/$REPO:latest || echo "ğŸš¨ ì´ë¯¸ì§€ digest í™•ì¸ ì‹¤íŒ¨"
